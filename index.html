<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dark Runner for Kids</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Optional: Google AdSense script (currently commented out) -->
  <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> -->
  <style>
    /* Dark Theme Global Styles */
    body {
      margin: 0;
      overflow: hidden;
      background-color: #121212;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      color: #e0e0e0;
    }
    canvas {
      display: block;
      background: #1e1e1e;
    }
    /* Start Overlay */
    #startOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #startOverlay h1 {
      color: #ffeb3b;
      font-size: 3em;
      margin-bottom: 20px;
    }
    #startOverlay button {
      padding: 15px 30px;
      font-size: 1.5em;
      background: #ffeb3b;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: #121212;
    }
    /* Game Over Overlay */
    #gameOverOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      text-align: center;
    }
    #gameOverOverlay h1 {
      color: #e74c3c;
      font-size: 3em;
      margin-bottom: 20px;
    }
    #gameOverOverlay button {
      padding: 10px 20px;
      font-size: 1em;
      background: #ffeb3b;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #121212;
      margin: 10px;
    }
    /* Ad Overlay (shown every 4 levels for 30 seconds) */
    #adOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 900;
    }
    #adOverlay p {
      margin: 10px;
      font-size: 1.8em;
    }
    /* Settings Overlay */
    #settingsOverlay, #highScoresOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(50,50,50,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 950;
    }
    #settingsOverlay h2, #highScoresOverlay h2 {
      font-size: 2em;
      margin-bottom: 20px;
      color: #ffeb3b;
    }
    #settingsOverlay label, #highScoresOverlay li {
      font-size: 1.2em;
      margin: 5px;
    }
    #settingsOverlay button, #highScoresOverlay button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      background: #ffeb3b;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #121212;
    }
    /* Control Buttons */
    .controlButton {
      position: absolute;
      top: 10px;
      padding: 10px 15px;
      background: #ffeb3b;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      cursor: pointer;
      z-index: 800;
      color: #121212;
    }
    #restartWithoutSaveButton, #saveAndRestartButton {
      margin: 10px;
      padding: 10px 20px;
      font-size: 1em;
      background: #ffeb3b;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #121212;
    }
    #saveScoreButton { left: 10px; }
    #settingsButton { right: 10px; }
    #viewHighScoresButton { left: 10px; top: 60px; }
  </style>
</head>
<body>
  <!-- Game Canvas -->
  <canvas id="gameCanvas" role="img" aria-label="Game canvas"></canvas>
  
  <!-- Start Overlay -->
  <div id="startOverlay" role="dialog" aria-modal="true" aria-labelledby="startTitle">
    <h1 id="startTitle">Dark Runner for Kids</h1>
    <button id="startGameButton" aria-label="Start game">Start Game</button>
  </div>
  
  <!-- Game Over Overlay -->
  <div id="gameOverOverlay" role="alertdialog" aria-live="assertive">
    <h1>Game Over</h1>
    <button id="restartWithoutSaveButton" aria-label="Restart without saving">Restart</button>
    <button id="saveAndRestartButton" aria-label="Save score and restart">Save Score & Restart</button>
  </div>
  
  <!-- Ad Overlay (shown every 4 levels for 30 seconds) -->
  <div id="adOverlay" role="alertdialog" aria-live="assertive">
    <p>Advertisement</p>
    <!-- Google AdSense ad unit (currently commented out) -->
    <!--
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1234567890123456"
         data-ad-slot="1234567890"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    -->
    <p id="adCountdown">30</p>
  </div>
  
  <!-- Settings Overlay -->
  <div id="settingsOverlay" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <h2 id="settingsTitle">Settings</h2>
    <label for="soundToggle">Sound:</label>
    <select id="soundToggle" aria-label="Toggle sound on or off">
      <option value="on">On</option>
      <option value="off">Off</option>
    </select>
    <button id="closeSettingsButton" aria-label="Close settings">Close</button>
  </div>
  
  <!-- High Scores Overlay -->
  <div id="highScoresOverlay" role="dialog" aria-modal="true" aria-labelledby="highScoresTitle">
    <h2 id="highScoresTitle">High Scores</h2>
    <ul id="highScoresList" style="list-style: none; padding: 0;"></ul>
    <button id="closeHighScoresButton" aria-label="Close high scores">Close</button>
  </div>
  
  <!-- Control Buttons -->
  <button id="saveScoreButton" class="controlButton" aria-label="Save your score">Save Score</button>
  <button id="settingsButton" class="controlButton" aria-label="Open settings">Settings</button>
  <button id="viewHighScoresButton" class="controlButton" aria-label="View high scores">View High Scores</button>
  
  <script>
    "use strict";
    
    // --- Canvas Setup ---
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // --- Global Game Variables ---
    let gameState = "menu"; // "menu", "running", "ad", "gameover"
    let score = 0;
    let level = 1;
    const levelThreshold = 100;
    let lastTimestamp = 0;
    
    // Difficulty parameters
    let obstacleSpeed = 5;
    let obstacleInterval = 2000; // ms
    let obstacleTimer = 0;
    
    // Overlays
    const startOverlay = document.getElementById("startOverlay");
    const gameOverOverlay = document.getElementById("gameOverOverlay");
    const adOverlay = document.getElementById("adOverlay");
    const adCountdownElem = document.getElementById("adCountdown");
    const settingsOverlay = document.getElementById("settingsOverlay");
    const highScoresOverlay = document.getElementById("highScoresOverlay");
    
    // Settings
    let soundEnabled = true;
    
    // Power-up variables
    let flightEnabled = false;
    let flightTimer = 0;
    let highJumpEnabled = false;
    let highJumpTimer = 0;
    
    // Sounds
    const jumpSound = new Audio("https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg");
    jumpSound.preload = "auto";
    const levelUpSound = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
    levelUpSound.preload = "auto";
    const powerUpSound = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
    powerUpSound.preload = "auto";
    
    // --- Player Object ---
    const player = {
      x: 50,
      y: canvas.height - 150,
      width: 50,
      height: 50,
      vy: 0,
      jumpForce: -15,
      gravity: 0.8,
      onGround: true
    };
    
    // --- Obstacles Array ---
    // Types: "ground", "flying", "platform", "item"
    let obstacles = [];
    const obstacleColors = {
      ground: "#88d8b0",
      flying: "#ffab91",
      platform: "#a29bfe",
      item: "#55efc4"
    };
    
    // --- Event Listeners for Jumping (Keyboard & Touch) ---
    canvas.addEventListener("touchstart", function(e) {
      e.preventDefault();
      if (gameState === "running" && player.onGround) {
        player.vy = player.jumpForce;
        player.onGround = false;
        if (soundEnabled) jumpSound.play();
      }
    });
    document.addEventListener("keydown", function(e) {
      if (e.code === "Space" && gameState === "running" && player.onGround) {
        player.vy = player.jumpForce;
        player.onGround = false;
        if (soundEnabled) jumpSound.play();
      }
    });
    
    // --- Start Game Button ---
    document.getElementById("startGameButton").addEventListener("click", function() {
      startOverlay.style.display = "none";
      gameState = "running";
      lastTimestamp = performance.now();
      requestAnimationFrame(gameLoop);
    });
    
    // --- Game Over Overlay Functions ---
    function showGameOverOverlay() {
      gameState = "gameover";
      gameOverOverlay.style.display = "flex";
    }
    function restartGame() {
      resetGame();
      gameOverOverlay.style.display = "none";
      gameState = "running";
      lastTimestamp = performance.now();
      requestAnimationFrame(gameLoop);
    }
    function saveScoreAndRestart() {
      // Save only if current score is higher than best score saved.
      let bestScore = parseInt(localStorage.getItem("bestScore") || "0");
      if (score > bestScore) {
        localStorage.setItem("bestScore", Math.floor(score));
        alert("New high score saved!");
      } else {
        alert("Score not high enough. Your best score remains " + bestScore);
      }
      restartGame();
    }
    document.getElementById("restartWithoutSaveButton").addEventListener("click", restartGame);
    document.getElementById("saveAndRestartButton").addEventListener("click", saveScoreAndRestart);
    
    // --- Settings Overlay ---
    document.getElementById("settingsButton").addEventListener("click", () => {
      settingsOverlay.style.display = "flex";
    });
    document.getElementById("closeSettingsButton").addEventListener("click", () => {
      settingsOverlay.style.display = "none";
    });
    document.getElementById("soundToggle").addEventListener("change", function() {
      soundEnabled = (this.value === "on");
      console.log("Sound enabled:", soundEnabled);
    });
    
    // --- High Scores Overlay ---
    function displayHighScores() {
      const list = document.getElementById("highScoresList");
      list.innerHTML = "";
      let highScores = JSON.parse(localStorage.getItem("bestScoreArray") || "[]");
      // For this implementation, we use a simple best score (from localStorage "bestScore")
      let bestScore = localStorage.getItem("bestScore") || "0";
      let li = document.createElement("li");
      li.textContent = "Best Score: " + bestScore;
      list.appendChild(li);
      highScoresOverlay.style.display = "flex";
    }
    document.getElementById("viewHighScoresButton").addEventListener("click", displayHighScores);
    document.getElementById("closeHighScoresButton").addEventListener("click", () => {
      highScoresOverlay.style.display = "none";
    });
    
    // --- Collision Detection Helper ---
    function rectIntersect(r1, r2) {
      return !(r2.x > r1.x + r1.width ||
               r2.x + r2.width < r1.x ||
               r2.y > r1.y + r1.height ||
               r2.y + r2.height < r1.y);
    }
    
    // --- Spawn Obstacles with Multiple Types ---
    function spawnObstacle() {
      let rnd = Math.random();
      let type;
      if (rnd < 0.5) {
        type = "ground"; // 50%
      } else if (rnd < 0.7) {
        type = "flying"; // 20%
      } else if (rnd < 0.85) {
        type = "platform"; // 15%
      } else {
        type = "item"; // 15%
      }
      let obsWidth = 30 + Math.random() * 20;
      let obsHeight = 30 + Math.random() * 50;
      let x = canvas.width;
      let y;
      switch(type) {
        case "ground":
          y = canvas.height - 50 - obsHeight;
          break;
        case "flying":
          y = 50 + Math.random() * (canvas.height / 2 - obsHeight);
          break;
        case "platform":
          y = canvas.height - 200 - Math.random() * 100;
          break;
        case "item":
          y = 50 + Math.random() * (canvas.height / 2 - obsHeight);
          break;
      }
      let obstacle = {
        x: x,
        y: y,
        width: obsWidth,
        height: obsHeight,
        type: type,
        color: obstacleColors[type] || "#ffffff"
      };
      if (type === "item") {
        // For items, randomly assign a power-up type: "flight" or "highjump"
        obstacle.itemType = (Math.random() < 0.5) ? "flight" : "highjump";
        obstacle.color = "#55efc4"; // Bright green for power-ups
      }
      obstacles.push(obstacle);
    }
    
    // --- Power-Up Functions ---
    function enableFlight() {
      flightEnabled = true;
      flightTimer = 5000; // Flight lasts 5 seconds
      player.originalGravity = player.gravity;
      player.gravity = 0.2;
      if (soundEnabled) powerUpSound.play();
    }
    function enableHighJump() {
      highJumpEnabled = true;
      highJumpTimer = 5000; // High jump lasts 5 seconds
      player.originalJumpForce = player.jumpForce;
      player.jumpForce *= 1.5; // Increase jump force by 50%
      if (soundEnabled) powerUpSound.play();
    }
    function updatePowerUps(deltaTime) {
      if (flightEnabled) {
        flightTimer -= deltaTime;
        if (flightTimer <= 0) {
          flightEnabled = false;
          player.gravity = player.originalGravity;
        }
      }
      if (highJumpEnabled) {
        highJumpTimer -= deltaTime;
        if (highJumpTimer <= 0) {
          highJumpEnabled = false;
          player.jumpForce = player.originalJumpForce;
        }
      }
    }
    
    // --- Reset Game on Fatal Collision ---
    function resetGame() {
      score = 0;
      level = 1;
      obstacles = [];
      player.y = canvas.height - 150;
      player.vy = 0;
      gameState = "gameover";
    }
    
    function showGameOverOverlay() {
      gameOverOverlay.style.display = "flex";
    }
    
    // --- Game Update Function ---
    function update(deltaTime) {
      if (gameState === "running") {
        score += deltaTime * 0.01;
        if (score >= level * levelThreshold) {
          level++;
          if (soundEnabled) levelUpSound.play();
          if (level % 4 === 0) {
            gameState = "ad";
            startAd();
          }
        }
        updatePowerUps(deltaTime);
        // Update player physics
        player.vy += player.gravity;
        player.y += player.vy;
        if (player.y + player.height >= canvas.height - 50) {
          player.y = canvas.height - 50 - player.height;
          player.vy = 0;
          player.onGround = true;
        }
        // Spawn obstacles
        obstacleTimer += deltaTime;
        if (obstacleTimer >= obstacleInterval) {
          spawnObstacle();
          obstacleTimer = 0;
        }
        // Update obstacles and collision check
        for (let i = obstacles.length - 1; i >= 0; i--) {
          obstacles[i].x -= obstacleSpeed;
          if (obstacles[i].x + obstacles[i].width < 0) {
            obstacles.splice(i, 1);
            continue;
          }
          if (rectIntersect(player, obstacles[i])) {
            if (obstacles[i].type === "item") {
              // Collect power-up
              if (obstacles[i].itemType === "flight") {
                enableFlight();
              } else if (obstacles[i].itemType === "highjump") {
                enableHighJump();
              }
              obstacles.splice(i, 1);
            } else {
              resetGame();
              showGameOverOverlay();
              return; // Stop further processing in this update cycle.
            }
          }
        }
      }
    }
    
    // --- Render Function ---
    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Background gradient
      let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
      grad.addColorStop(0, "#2c3e50");
      grad.addColorStop(1, "#34495e");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      // Ground
      ctx.fillStyle = "#1c2833";
      ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
      // Draw player: if flying, draw in gold; else red.
      ctx.fillStyle = flightEnabled ? "#f1c40f" : "#e74c3c";
      ctx.beginPath();
      ctx.arc(player.x + player.width/2, player.y + player.height/2, player.width/2, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = "#ffffff";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(player.x + player.width/2, player.y + player.height/2, player.width/3, 0, Math.PI);
      ctx.stroke();
      // Draw obstacles
      obstacles.forEach(obs => {
        ctx.fillStyle = obs.color;
        ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
      });
      // Draw score and level centered at top
      ctx.fillStyle = "#ecf0f1";
      ctx.font = "24px Comic Sans MS";
      let scoreText = "Score: " + Math.floor(score);
      let levelText = "Level: " + level;
      let scoreWidth = ctx.measureText(scoreText).width;
      let levelWidth = ctx.measureText(levelText).width;
      ctx.fillText(scoreText, (canvas.width - scoreWidth) / 2, 30);
      ctx.fillText(levelText, (canvas.width - levelWidth) / 2, 60);
    }
    
    // --- Game Loop ---
    function gameLoop(timestamp) {
      const deltaTime = timestamp - lastTimestamp;
      lastTimestamp = timestamp;
      update(deltaTime);
      render();
      if (gameState === "running" || gameState === "ad") {
        requestAnimationFrame(gameLoop);
      }
    }
    
    // --- Ad Overlay Functionality ---
    function startAd() {
      let adCountdown = 30;
      adOverlay.style.display = "flex";
      adCountdownElem.textContent = adCountdown;
      // Google AdSense code is commented out for now.
      // try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(e) { console.error("Error initializing ad unit:", e); }
      let adTimer = setInterval(() => {
        adCountdown--;
        adCountdownElem.textContent = adCountdown;
        if (adCountdown <= 0) {
          clearInterval(adTimer);
          adOverlay.style.display = "none";
          // Increase difficulty for next round.
          obstacleSpeed += 1;
          if (obstacleInterval > 500) obstacleInterval -= 200;
          gameState = "running";
          lastTimestamp = performance.now();
          requestAnimationFrame(gameLoop);
        }
      }, 1000);
    }
    
    // --- Restart and Reset Functions ---
    function resetGame() {
      score = 0;
      level = 1;
      obstacles = [];
      player.y = canvas.height - 150;
      player.vy = 0;
      gameState = "gameover";
    }
    function showGameOverOverlay() {
      gameOverOverlay.style.display = "flex";
    }
    function restartGame() {
      resetGame();
      gameOverOverlay.style.display = "none";
      gameState = "running";
      lastTimestamp = performance.now();
      requestAnimationFrame(gameLoop);
    }
    function saveScoreAndRestart() {
      let bestScore = parseInt(localStorage.getItem("bestScore") || "0");
      if (score > bestScore) {
        localStorage.setItem("bestScore", Math.floor(score));
        alert("New high score saved!");
      } else {
        alert("Score not high enough. Your best score remains " + bestScore);
      }
      restartGame();
    }
    
    // --- Control Buttons for Game Over Overlay ---
    document.getElementById("restartWithoutSaveButton").addEventListener("click", restartGame);
    document.getElementById("saveAndRestartButton").addEventListener("click", saveScoreAndRestart);
    
    // --- Accessibility: Set ARIA roles for overlays ---
    adOverlay.setAttribute("role", "alertdialog");
    settingsOverlay.setAttribute("role", "dialog");
    highScoresOverlay.setAttribute("role", "dialog");
    gameOverOverlay.setAttribute("role", "alertdialog");
    
    // --- Start the Game Loop --- 
    // The game loop starts when the "Start Game" button is pressed.
  </script>
</body>
</html>
